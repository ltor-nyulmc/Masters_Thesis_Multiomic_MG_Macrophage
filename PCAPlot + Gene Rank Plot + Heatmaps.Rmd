```{r}
# Load necessary libraries
if (!require("readxl")) install.packages("readxl")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("factoextra")) install.packages("factoextra")
if (!require("dplyr")) install.packages("dplyr")

library(readxl)
library(ggplot2)
library(factoextra)
library(dplyr)

# Load the VSD data from the .xlsx file
vsd_data <- read_excel("~/Desktop/PCA/Normalized_VSD (1).xlsx")

# Check for duplicate gene names
sum(duplicated(vsd_data$gene))  # This will show how many duplicates there are

# If duplicates exist, remove them (we'll keep the first occurrence)
vsd_data <- vsd_data[!duplicated(vsd_data$gene), ]

# Set the gene names as row names
rownames(vsd_data) <- vsd_data$gene
vsd_data <- vsd_data[,-1]  # Remove the gene column after setting row names

# Manually create the Condition vector based on your clarification (for samples)
conditions <- c(rep("500uM", 12), rep("5mM", 12))  # B-M are 500uM, N-Y are 5mM

# Now transpose the data for PCA (genes in columns, samples in rows)
vsd_data_t <- t(vsd_data)

# Assign the conditions as a new column in the transposed data (samples)
vsd_data_pca <- as.data.frame(vsd_data_t)  # Convert to data frame for easier handling
vsd_data_pca$Condition <- conditions

# Perform PCA on the transposed data (excluding the Condition column)
pca_result <- prcomp(vsd_data_pca[, -ncol(vsd_data_pca)], scale. = TRUE)  # Scaling included

# Zoom in on the PCA plot by limiting the axes
fviz_pca_ind(pca_result,
             geom.ind = "point",  # Show points only
             col.ind = vsd_data_pca$Condition,  # Color by condition
             palette = c("blue", "red"),  # Adjust colors as needed
             addEllipses = TRUE,  # Add confidence ellipses
             ellipse.level = 0.95,  # 95% confidence level
             legend.title = "Condition") +
  ggtitle("PCA Plot: 500uM vs 5mM") +
  xlim(-5, 5) +  # Set x-axis limits to zoom in
  ylim(-5, 5)    # Set y-axis limits to zoom in

```

```{r}
# Load necessary libraries
if (!require("readxl")) install.packages("readxl")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("factoextra")) install.packages("factoextra")
if (!require("dplyr")) install.packages("dplyr")

library(readxl)
library(ggplot2)
library(factoextra)
library(dplyr)

# Load the VSD data from the .xlsx file
vsd_data <- read_excel("~/Desktop/PCA/Normalized_VSD (1).xlsx")

# Check for duplicate gene names
sum(duplicated(vsd_data$gene))  # This will show how many duplicates there are

# If duplicates exist, remove them (we'll keep the first occurrence)
vsd_data <- vsd_data[!duplicated(vsd_data$gene), ]

# Set the gene names as row names
rownames(vsd_data) <- vsd_data$gene
vsd_data <- vsd_data[,-1]  # Remove the gene column after setting row names

# Manually create the Condition vector based on your clarification (for samples)
conditions <- c(rep("500uM", 12), rep("5mM", 12))  # B-M are 500uM, N-Y are 5mM

# Ensure that all non-finite values (NA, Inf) are removed or imputed
vsd_data[is.na(vsd_data)] <- 0  # Replacing any remaining NA values with 0

# Now transpose the data for PCA (genes in columns, samples in rows)
vsd_data_t <- t(vsd_data)

# Assign the conditions as a new column in the transposed data (samples)
vsd_data_pca <- as.data.frame(vsd_data_t)  # Convert to data frame for easier handling
vsd_data_pca$Condition <- conditions

# Perform PCA on the transposed data (excluding the Condition column)
pca_result <- prcomp(vsd_data_pca[, -ncol(vsd_data_pca)], scale. = TRUE)  # Scaling included

# Adjust the plot
fviz_pca_ind(pca_result,
             geom.ind = "point",  # Show points only
             col.ind = vsd_data_pca$Condition,  # Color by condition
             palette = c("blue", "red"),  # Adjust colors as needed
             addEllipses = TRUE,  # Add confidence ellipses
             ellipse.level = 0.95,  # 95% confidence level
             legend.title = "Condition") +
  ggtitle("PCA Plot: 500uM vs 5mM") +
  xlim(-10, 10) +  # Tighter x-axis limits
  ylim(-10, 10)    # Tighter y-axis limits

```
```{r}
# Ensure the dataset is in a numeric matrix format
vsd_data <- as.data.frame(vsd_data)  # Ensure it's a dataframe if it's a list
vsd_data[] <- lapply(vsd_data, as.numeric)  # Convert all columns to numeric

# Now handle non-finite values (e.g., NA, Inf, NaN)
# Replace non-finite values with NA
vsd_data[!is.finite(as.matrix(vsd_data))] <- NA

# Impute missing values (e.g., NA) with the mean of the column
vsd_data[is.na(vsd_data)] <- apply(vsd_data, 2, function(x) mean(x, na.rm = TRUE))

# Continue with the PCA after cleaning
vsd_data_t <- t(vsd_data)  # Transpose for PCA
vsd_data_pca <- as.data.frame(vsd_data_t)
vsd_data_pca$Condition <- conditions  # Add conditions as a column

# Perform PCA
pca_result <- prcomp(vsd_data_pca[, -ncol(vsd_data_pca)], scale. = TRUE)

# Plot the PCA
fviz_pca_ind(pca_result, 
             geom.ind = "point",
             col.ind = vsd_data_pca$Condition,
             palette = c("blue", "red"),
             addEllipses = TRUE,
             ellipse.level = 0.95,
             legend.title = "Condition") +
  ggtitle("PCA Plot: 500uM vs 5mM")

# Plot without limiting the axes
fviz_pca_ind(pca_result,
             geom.ind = "point", 
             col.ind = vsd_data_pca$Condition,
             palette = c("blue", "red"),
             addEllipses = TRUE,
             ellipse.level = 0.95,
             legend.title = "Condition") +
  ggtitle("PCA Plot: 500uM vs 5mM")


```
Dim1 (40.3%) on the x-axis represents Principal Component 1 (PC1), which explains 40.3% of the variance in the dataset. This means that PC1 captures 40.3% of the differences between samples.
Dim2 (11.7%) on the y-axis represents Principal Component 2 (PC2), explaining 11.7% of the variance. This is the second most important dimension in explaining the variation between the samples.


```{r}
# Required libraries
library(factoextra)  # For PCA visualization
library(ggplot2)     # For plotting
library(dplyr)       # For data manipulation

# Perform PCA on the data (excluding the last 'Condition' column)
pca_result <- prcomp(vsd_data_pca[, -ncol(vsd_data_pca)], scale. = TRUE)

# Visualize the PCA plot with colored points by 'Condition'
fviz_pca_ind(pca_result, 
             geom.ind = "point",           # Use points to represent samples
             col.ind = vsd_data_pca$Condition,  # Color points by Condition
             palette = c("blue", "red"),   # Set color palette
             addEllipses = TRUE,           # Add 95% confidence ellipses
             ellipse.level = 0.95,         # Confidence level of ellipses
             legend.title = "Condition") + # Set legend title
  ggtitle("PCA Plot: 500uM vs 5mM")        # Add plot title

# Apply log2 transformation to the expression data
vsd_data_pca_log2 <- log2(vsd_data_pca[, -ncol(vsd_data_pca)] + 1)  # Add 1 to avoid log(0)

# Perform PCA on the log2-transformed data
pca_result_log2 <- prcomp(vsd_data_pca_log2, scale. = TRUE)

# Visualize the PCA plot with colored points by 'Condition'
fviz_pca_ind(pca_result_log2, 
             geom.ind = "point",           # Use points to represent samples
             col.ind = vsd_data_pca$Condition,  # Color points by Condition
             palette = c("blue", "red"),   # Set color palette
             addEllipses = TRUE,           # Add 95% confidence ellipses
             ellipse.level = 0.95,         # Confidence level of ellipses
             legend.title = "Condition") + # Set legend title
  ggtitle("PCA Plot: 500uM vs 5mM (log2-transformed)")

```
```{r}
# Visualize the PCA plot with colored points and labels using ggrepel
fviz_pca_ind(pca_result_log2, 
             geom.ind = "point",                # Use points to represent samples
             col.ind = vsd_data_pca$Condition,  # Color points by Condition
             palette = c("blue", "red"),        # Set color palette
             addEllipses = TRUE,                # Add 95% confidence ellipses
             ellipse.level = 0.95,              # Confidence level of ellipses
             legend.title = "Condition") +      # Set legend title
  geom_text_repel(aes(label = sample_names),    # Use ggrepel for non-overlapping labels
                  size = 3,                    # Adjust label size
                  box.padding = 0.5,           # Add padding around labels
                  point.padding = 0.5,         # Padding between points and labels
                  max.overlaps = Inf) +        # Increase maximum overlaps to show all labels
  ggtitle("PCA Plot: 500uM vs 5mM (log2-transformed)")  # Add plot title

```
X-axis (PC1: Principal Component 1): This represents the direction where the data shows the highest variance (40.3% in this case). Variance means how much the data points differ from each other. The larger the spread along this axis, the more variance PC1 explains.

Y-axis (PC2: Principal Component 2): This represents the second-highest variance in the data (11.7%). PC2 is orthogonal to PC1, meaning it captures variance that is independent of the variance captured by PC1.
Together, PC1 and PC2 explain about 52% of the variance in dataset, as shown by their percentage labels.

Concentration Differences (500uM vs 5mM): The PCA plot suggests that the 500uM and 5mM groups have distinct gene expression profiles, as they are separated along both PC1 and PC2. This separation may indicate that the difference in concentration is contributing to a significant variance in the gene expression data.
The 500uM samples are generally clustered toward the positive side of both PC1 and PC2.
The 5mM samples are clustered on the negative side of PC1 and PC2.


```{r}
apply(vsd_data, 2, var)  # Check variance of each column

```
```{r}
# Load necessary libraries (install if not present)
if (!require("readxl")) install.packages("readxl", dependencies = TRUE)
if (!require("ggplot2")) install.packages("ggplot2", dependencies = TRUE)
if (!require("factoextra")) install.packages("factoextra", dependencies = TRUE)
if (!require("dplyr")) install.packages("dplyr", dependencies = TRUE)
if (!require("ggrepel")) install.packages("ggrepel", dependencies = TRUE)

# Load libraries
library(readxl)
library(ggplot2)
library(factoextra)
library(dplyr)
library(ggrepel)

# Load the VSD data from the .xlsx file (ensure correct file path)
file_path <- "/Users/gui/Desktop/PCA/Normalized_VSD (1).xlsx"
if (!file.exists(file_path)) {
  stop("File not found. Please check the file path.")
}

vsd_data <- read_excel(file_path)

# Check for duplicate gene names
num_duplicates <- sum(duplicated(vsd_data$gene))
cat("Number of duplicate gene names: ", num_duplicates, "\n")

# If duplicates exist, remove them (keep the first occurrence)
vsd_data <- vsd_data[!duplicated(vsd_data$gene), ]

# Set the gene names as row names
rownames(vsd_data) <- vsd_data$gene
vsd_data <- vsd_data[, -1]  # Remove the gene column after setting row names

# Manually create the Condition vector based on your clarification (for samples)
conditions <- c(rep("500uM", 12), rep("5mM", 12))  # Columns B-M are 500uM, N-Y are 5mM

# Ensure that all non-finite values (NA, Inf) are removed or imputed
vsd_data[is.na(vsd_data)] <- 0  # Replace any remaining NA values with 0

# Convert all columns to numeric to avoid coercion issues
vsd_data[] <- lapply(vsd_data, as.numeric)

# Transpose the data for PCA (genes in columns, samples in rows)
vsd_data_t <- t(vsd_data)

# Assign the conditions as a new column in the transposed data (samples)
vsd_data_pca <- as.data.frame(vsd_data_t)  # Convert to data frame for easier handling
vsd_data_pca$Condition <- conditions

# Perform PCA on the transposed data (excluding the Condition column)
pca_result <- prcomp(vsd_data_pca[, -ncol(vsd_data_pca)], scale. = TRUE)  # Scaling included

# Visualize the PCA plot with colored points by 'Condition'
final_plot <- fviz_pca_ind(pca_result, 
                           geom.ind = "point",                # Use points to represent samples
                           col.ind = vsd_data_pca$Condition,    # Color points by Condition
                           palette = c("blue", "red"),        # Set color palette
                           addEllipses = TRUE,                  # Add 95% confidence ellipses
                           ellipse.level = 0.95,                # Confidence level of ellipses
                           legend.title = "Condition") +       # Set legend title
  ggtitle("PCA Plot: 500uM vs 5mM (log2-transformed)") +       # Add plot title
  geom_text_repel(aes(label = rownames(vsd_data_pca)),          # Add sample labels using ggrepel
                  size = 3,                                    # Adjust label size
                  box.padding = 0.5,                           # Add padding around labels
                  point.padding = 0.5,                         # Padding between points and labels
                  max.overlaps = Inf) +                        # Show all labels
  theme_minimal() +                                            # Clean theme
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),         # Centered and larger title
    axis.text = element_text(size = 12),                       # Larger axis labels
    axis.title = element_text(size = 14),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )

# Print the final PCA plot
print(final_plot)
```



HEATMAPS

```{r}
# Corrected file path (this was the working part for you)
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read_csv(file_path)

# Load necessary libraries
library(dplyr)
library(ggplot2)

# Separate the columns corresponding to 5mM and 500uM conditions
data_500uM <- vsd_data[, 2:13]  # Columns B-M for 500uM
data_5mM <- vsd_data[, 14:25]   # Columns N-Y for 5mM

# Calculate the average expression for 500uM and 5mM
avg_500uM <- rowMeans(data_500uM, na.rm = TRUE)
avg_5mM <- rowMeans(data_5mM, na.rm = TRUE)

# Calculate the fold change between 5mM and 500uM (log2 fold change)
log2_fold_change <- log2(avg_5mM + 1) - log2(avg_500uM + 1)

# Add the log2 fold change to the original data
vsd_data$log2FC <- log2_fold_change

# Rank the genes by the log2 fold change
vsd_data_ranked <- vsd_data %>% arrange(desc(log2FC))

# Select the top 20 upregulated and top 20 downregulated genes
top_upregulated <- head(vsd_data_ranked, 20)
top_downregulated <- tail(vsd_data_ranked, 20)

# Combine the top up and downregulated genes
top_genes <- rbind(top_upregulated, top_downregulated)

# Display the table to confirm
print(top_genes)

```
```{r}
# Install necessary libraries if not already installed
if (!requireNamespace("pheatmap", quietly = TRUE)) {
  install.packages("pheatmap")
}

# Load libraries
library(dplyr)
library(pheatmap)
library(readr)

# File path
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load your CSV file
vsd_data <- read_csv(file_path)

# Let's assume vsd_data already has genes in the first column and expression values in the following columns
# Ensure we have the log2 fold change data if not done previously
# Assuming that columns N-Y correspond to 5 mM condition and columns B-M to 500 uM
condition_5mM <- vsd_data[, c(14:25)]  # columns for 5mM condition
condition_500uM <- vsd_data[, c(2:13)] # columns for 500uM condition

# Calculate log2FC for 5 mM vs. 500 µM
log2FC <- rowMeans(condition_5mM) - rowMeans(condition_500uM)

# Add the log2FC to the original data
vsd_data <- vsd_data %>%
  mutate(log2FC = log2FC)

# Sort the data by log2FC for upregulated and downregulated genes
top_upregulated <- vsd_data %>%
  arrange(desc(log2FC)) %>%
  slice(1:20)

top_downregulated <- vsd_data %>%
  arrange(log2FC) %>%
  slice(1:20)

# Combine top upregulated and downregulated genes
top_genes <- bind_rows(top_upregulated, top_downregulated)

# Extract expression values of top genes
expression_data <- top_genes %>%
  select(-gene, -log2FC)

# Set rownames to gene names
rownames(expression_data) <- top_genes$gene

# Increase the output image size
pheatmap(as.matrix(expression_data),
         scale = "row",                          # Standardize the data across genes (rows)
         clustering_distance_rows = "euclidean", # Use Euclidean distance for clustering rows
         clustering_distance_cols = "euclidean", # Use Euclidean distance for clustering columns
         clustering_method = "complete",         # Clustering method
         color = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
         fontsize_row = 10,                      # Adjust the font size for the gene names
         fontsize_col = 10,                      # Adjust the font size for the sample labels
         angle_col = 90,                         # Rotate the column labels to 90 degrees for better readability
         main = "Heatmap of Top 20 Up and Downregulated Genes", # Title
         legend = TRUE,                          # Show legend
         cellwidth = 20,                         # Increase width of cells to avoid cutting off
         cellheight = 20,                        # Increase height of cells for better readability
         border_color = NA,                      # Remove grid lines between cells
         fontsize = 12,                          # General font size adjustment
         treeheight_row = 50,                    # Height for the row dendrogram
         treeheight_col = 50                     # Height for the column dendrogram
)

```
```{r}
# Load necessary libraries
library(pheatmap)

# Adjust the heatmap to fit all elements and avoid cut-offs
pheatmap(as.matrix(expression_data),
         scale = "row",                           # Standardize the data across genes (rows)
         clustering_distance_rows = "euclidean",  # Use Euclidean distance for clustering rows
         clustering_distance_cols = "euclidean",  # Use Euclidean distance for clustering columns
         clustering_method = "complete",          # Clustering method
         color = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
         fontsize_row = 12,                       # Adjust the font size for the gene names
         fontsize_col = 12,                       # Adjust the font size for the sample labels
         angle_col = 90,                          # Rotate the column labels to 90 degrees for better readability
         main = "Heatmap of Top 20 Up and Downregulated Genes",  # Title
         legend = TRUE,                           # Show legend
         cellwidth = 20,                          # Set width of cells for readability
         cellheight = 20,                         # Set height of cells for readability
         border_color = NA,                       # Remove grid lines between cells
         fontsize = 14,                           # General font size adjustment
         treeheight_row = 50,                     # Height for the row dendrogram
         treeheight_col = 50,                     # Height for the column dendrogram
         height = 10,                             # Adjust the overall height of the plot
         width = 12                               # Adjust the overall width of the plot
)

```
```{r}
# Load necessary libraries
if (!require("ComplexHeatmap")) install.packages("ComplexHeatmap")
if (!require("circlize")) install.packages("circlize")
if (!require("readxl")) install.packages("readxl")
if (!require("dplyr")) install.packages("dplyr")

library(ComplexHeatmap)
library(circlize)
library(readxl)
library(dplyr)

# Corrected file path
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read.csv(file_path, header = TRUE)

# Separate the columns corresponding to the 5mM condition
data_5mM <- vsd_data[, 14:25]  # Columns N-Y for 5mM

# Calculate the average expression for 5mM
avg_5mM <- rowMeans(data_5mM, na.rm = TRUE)

# Add the average 5mM to the original data
vsd_data$avg_5mM <- avg_5mM

# Rank the genes by the average 5mM expression
vsd_data_ranked <- vsd_data %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression in the 5mM condition
top_5mM_genes <- head(vsd_data_ranked, 25)

# Prepare data for the heatmap (including only the top genes)
heatmap_data <- top_5mM_genes %>%
  select(-avg_5mM)  # Remove avg_5mM column to retain expression values

# Set gene names as row names for the heatmap data
rownames(heatmap_data) <- heatmap_data$gene
heatmap_data <- heatmap_data[, -1]  # Remove the gene column after setting it as row names

# Scale the data row-wise to highlight differences between samples
heatmap_data_scaled <- t(scale(t(heatmap_data)))  # Scaling by row (genes)

# Generate the heatmap with ComplexHeatmap and add values in cells
Heatmap(as.matrix(heatmap_data_scaled),
        name = "Expression Level",
        col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),  # Color scale for expression
        cluster_rows = TRUE,  # Cluster rows
        cluster_columns = TRUE,  # Cluster columns
        show_row_names = TRUE,  # Show gene names
        show_column_names = TRUE,  # Show sample names
        row_names_gp = gpar(fontsize = 10, fontface = "bold"),  # Increase gene name font size for readability
        column_names_gp = gpar(fontsize = 8, rot = 45),  # Reduce sample name font size and rotate labels for better readability
        cell_fun = function(j, i, x, y, width, height, fill) {
          grid.text(sprintf("%.1f", heatmap_data_scaled[i, j]), x, y, gp = gpar(fontsize = 6, col = "black"))
        },
        heatmap_legend_param = list(title = "Expression Level", title_gp = gpar(fontsize = 14, fontface = "bold"), labels_gp = gpar(fontsize = 10)),
        column_title = "Top 25 Genes in 5mM Condition",
        row_title = "Genes",
        column_title_gp = gpar(fontsize = 16, fontface = "bold"),
        row_title_gp = gpar(fontsize = 16, fontface = "bold"),
        height = unit(10, "cm"),  # Set height to ensure labels fit properly
        width = unit(15, "cm"))  # Set width to ensure labels fit properly

```
```{r}
#5mM GROUPPP
# Load necessary libraries
library(tidyverse)
library(pheatmap)

# Corrected file path (this was the working part for you)
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read_csv(file_path)

# Extract only the columns corresponding to gene names and 5mM condition
data_5mM <- vsd_data %>% select(gene, starts_with("G"))  # Assuming the 5mM columns start with "G"

# Calculate the average expression for the 5mM condition
avg_5mM <- data_5mM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_5mM <- data_5mM %>% mutate(avg_5mM = avg_5mM)

# Rank the genes by the average expression level
vsd_data_ranked <- data_5mM %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression
top_genes <- vsd_data_ranked %>% head(25)

# Set the gene names as row names using tidyverse approach
heatmap_data <- top_genes %>% column_to_rownames(var = "gene")

# Generate heatmap with adjusted settings for better readability
pheatmap(
  as.matrix(heatmap_data[, -ncol(heatmap_data)]),  # Remove the avg_5mM column for the heatmap
  scale = "row",                           # Standardize the data across genes (rows)
  clustering_distance_rows = "euclidean",  # Use Euclidean distance for clustering rows
  clustering_distance_cols = "euclidean",  # Use Euclidean distance for clustering columns
  clustering_method = "complete",          # Clustering method
  color = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  fontsize_row = 10,                        # Adjust the font size for the gene names
  fontsize_col = 10,                        # Adjust the font size for the sample labels
  angle_col = "45",                           # Rotate the column labels to 45 degrees for better readability
  main = "Top 25 Genes in 5mM Condition",  # Title
  legend = TRUE,                            # Show legend
  treeheight_row = 30,                      # Adjust the row dendrogram height
  treeheight_col = 30,                      # Adjust the column dendrogram height
  border_color = NA                         # Remove grid lines between cells for a cleaner look
)

```
```{r}
# Load necessary libraries
library(tidyverse)

# Corrected file path (this was the working part for you)
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read_csv(file_path)

# Extract only the columns corresponding to gene names and 5mM condition (Columns 2-13 for 5mM)
data_5mM <- vsd_data %>% select(gene, 2:13)

# Calculate the average expression for the 5mM condition
avg_5mM <- data_5mM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_5mM <- data_5mM %>% mutate(avg_5mM = avg_5mM)

# Rank the genes by the average expression level
vsd_data_ranked_5mM <- data_5mM %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression
top_genes_5mM <- vsd_data_ranked_5mM %>% head(25)

# Extract only the columns corresponding to gene names and 500uM condition (Columns 14-25 for 500uM)
data_500uM <- vsd_data %>% select(gene, 14:25)

# Calculate the average expression for the 500uM condition
avg_500uM <- data_500uM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_500uM <- data_500uM %>% mutate(avg_500uM = avg_500uM)

# Rank the genes by the average expression level
vsd_data_ranked_500uM <- data_500uM %>% arrange(desc(avg_500uM))

# Select the top 25 genes with the highest average expression
top_genes_500uM <- vsd_data_ranked_500uM %>% head(25)

# Print the top 25 genes for 5mM
print(top_genes_5mM)

# Print the top 25 genes for 500uM
print(top_genes_500uM)

```
```{r}
# Load necessary libraries
library(tidyverse)
library(ComplexHeatmap)

# Corrected file path (this was the working part for you)
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read_csv(file_path)

# Extract only the columns corresponding to gene names and 5mM condition (Columns 2-13 for 5mM)
data_5mM <- vsd_data %>% select(gene, 2:13)

# Calculate the average expression for the 5mM condition
avg_5mM <- data_5mM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_5mM <- data_5mM %>% mutate(avg_5mM = avg_5mM)

# Rank the genes by the average expression level
vsd_data_ranked_5mM <- data_5mM %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression
top_genes_5mM <- vsd_data_ranked_5mM %>% head(25)

# Generate heatmap for the top 25 genes in 5mM condition
top_genes_5mM_matrix <- top_genes_5mM %>% select(-gene, -avg_5mM) %>% as.matrix()
rownames(top_genes_5mM_matrix) <- top_genes_5mM$gene

# Scaling the data for better visualization
top_genes_5mM_matrix_scaled <- t(scale(t(top_genes_5mM_matrix)))

# Plot the heatmap using ComplexHeatmap
Heatmap(
  top_genes_5mM_matrix_scaled,
  name = "Expression Level",                # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 8, fontfamily = "sans", lineheight = .8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Expression Level"),  # Legend title
  column_title = "Top 25 Genes in 5mM Condition",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 14)     # Font size for the title
)

```
```{r}
# Extract only the columns corresponding to gene names and 500uM condition (Columns 14-25 for 500uM)
data_500uM <- vsd_data %>% select(gene, 14:25)

# Calculate the average expression for the 500uM condition
avg_500uM <- data_500uM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_500uM <- data_500uM %>% mutate(avg_500uM = avg_500uM)

# Rank the genes by the average expression level
vsd_data_ranked_500uM <- data_500uM %>% arrange(desc(avg_500uM))

# Select the top 25 genes with the highest average expression
top_genes_500uM <- vsd_data_ranked_500uM %>% head(25)

# Generate heatmap for the top 25 genes in 500uM condition
top_genes_500uM_matrix <- top_genes_500uM %>% select(-gene, -avg_500uM) %>% as.matrix()
rownames(top_genes_500uM_matrix) <- top_genes_500uM$gene

# Scaling the data for better visualization
top_genes_500uM_matrix_scaled <- t(scale(t(top_genes_500uM_matrix)))

# Plot the heatmap using ComplexHeatmap
Heatmap(
  top_genes_500uM_matrix_scaled,
  name = "Expression Level",                # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 8, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Expression Level"),  # Legend title
  column_title = "Top 25 Genes in 500uM Condition",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 14)     # Font size for the title
)

```
```{r}
# Extract matrices for 5mM and 500uM conditions
top_genes_5mM_matrix <- top_genes_5mM %>% select(-gene, -avg_5mM) %>% as.matrix()
rownames(top_genes_5mM_matrix) <- top_genes_5mM$gene

top_genes_500uM_matrix <- top_genes_500uM %>% select(-gene, -avg_500uM) %>% as.matrix()
rownames(top_genes_500uM_matrix) <- top_genes_500uM$gene

# Scaling the data for better visualization (both matrices)
top_genes_5mM_matrix_scaled <- t(scale(t(top_genes_5mM_matrix)))
top_genes_500uM_matrix_scaled <- t(scale(t(top_genes_500uM_matrix)))

# Determine common scale limits across both heatmaps
combined_matrix <- rbind(top_genes_5mM_matrix_scaled, top_genes_500uM_matrix_scaled)
lim <- max(abs(combined_matrix), na.rm = TRUE)

# Plot the heatmap for 5mM condition
Heatmap(
  top_genes_5mM_matrix_scaled,
  name = "Expression Level",
  col = colorRampPalette(c("blue", "white", "red"))(100),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 7, fontfamily = "sans", lineheight = 0.8),
  column_names_gp = gpar(fontsize = 9, rot = 90, fontfamily = "sans"),
  heatmap_legend_param = list(at = seq(-lim, lim, length.out = 5)),  # Set a common color scale
  column_title = "Top 25 Genes in 5mM Condition",
  column_title_gp = gpar(fontsize = 14)
)

# Plot the heatmap for 500uM condition
Heatmap(
  top_genes_500uM_matrix_scaled,
  name = "Expression Level",
  col = colorRampPalette(c("blue", "white", "red"))(100),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 7, fontfamily = "sans", lineheight = 0.8),
  column_names_gp = gpar(fontsize = 9, rot = 90, fontfamily = "sans"),
  heatmap_legend_param = list(at = seq(-lim, lim, length.out = 5)),  # Set a common color scale
  column_title = "Top 25 Genes in 500uM Condition",
  column_title_gp = gpar(fontsize = 14)

```
```{r}
# Extract only the columns corresponding to gene names and all conditions (Columns 2 to 13 for Group 5, MAG, OA, PA)
data_all_groups <- vsd_data %>% select(gene, 2:13)

# Rename the columns to make sure they are uniquely identifiable
colnames(data_all_groups) <- c("gene", paste0("Control_", 1:3), paste0("MAG_", 1:3), paste0("OA_", 1:3), paste0("PA_", 1:3))

# Separate out Group 5 (Control columns)
group5 <- data_all_groups %>% select(starts_with("Control"))

# Calculate average expression for Group 5 (Control)
avg_group5 <- group5 %>% rowMeans(na.rm = TRUE)

# Calculate differential expression for MAG, OA, PA relative to Group 5
data_diff <- data_all_groups %>%
  mutate(across(starts_with("MAG"), ~ . - avg_group5),
         across(starts_with("OA"), ~ . - avg_group5),
         across(starts_with("PA"), ~ . - avg_group5))

# Add back the gene names column
data_diff <- data_diff %>% mutate(gene = data_all_groups$gene)

# Rank the genes based on average differential expression
avg_diff_expression <- data_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff <- data_diff %>% mutate(avg_diff = avg_diff_expression) %>% arrange(desc(avg_diff))

# Select the top 25 genes with the highest average differential expression
top_genes_diff <- data_diff %>% head(25)

# Generate heatmap for the top 25 genes in differential expression
top_genes_diff_matrix <- top_genes_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% as.matrix()
rownames(top_genes_diff_matrix) <- top_genes_diff$gene

# Scaling the data for better visualization
top_genes_diff_matrix_scaled <- t(scale(t(top_genes_diff_matrix)))

# Define custom labels for samples (MAG, OA, PA)
col_labels <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Plot the heatmap using ComplexHeatmap
Heatmap(
  top_genes_diff_matrix_scaled,
  name = "Differential Expression",        # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  column_labels = col_labels,               # Custom labels for columns
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 10, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Differential Expression", at = round(seq(-lim, lim, length.out = 5), 4)),  # Legend title with rounded values to the nearest ten-thousandth
  column_title = "Top 25 Genes Differential Expression vs Control (5mM Sample)",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 12)     # Font size for the title
)

```



```{r}
# Extract only the columns corresponding to gene names and 5mM condition (Columns 17:25 for 5mM)
data_5mM <- vsd_data %>% select(gene, 17:25)

# Calculate the average expression for the 5mM condition
avg_5mM <- data_5mM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_5mM <- data_5mM %>% mutate(avg_5mM = avg_5mM)

# Rank the genes by the average expression level
vsd_data_ranked_5mM <- data_5mM %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression
top_genes_5mM <- vsd_data_ranked_5mM %>% head(25)

# Generate heatmap for the top 25 genes in 5mM condition
top_genes_5mM_matrix <- top_genes_5mM %>% select(-gene, -avg_5mM) %>% as.matrix()
rownames(top_genes_5mM_matrix) <- top_genes_5mM$gene

# Scaling the data for better visualization
top_genes_5mM_matrix_scaled <- t(scale(t(top_genes_5mM_matrix)))

# Define custom labels for samples (T6 for columns 17, 18, 19; T7 for columns 20, 21, 22; T8 for columns 23, 24, 25)
col_labels <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Plot the heatmap using ComplexHeatmap
Heatmap(
  top_genes_5mM_matrix_scaled,
  name = "Expression Level",                # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  column_labels = col_labels,               # Custom labels for columns
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 10, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Expression Level", at = round(seq(-max(abs(top_genes_5mM_matrix_scaled)), max(abs(top_genes_5mM_matrix_scaled)), length.out = 5), 4)),  # Legend title with rounded values
  column_title = "Top 25 Genes in 5mM Condition",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 14)     # Font size for the title
)

```
```{r}
# Extract only the columns corresponding to gene names and all conditions (Columns 2 to 13 for Group 5, MAG, OA, PA)
data_all_groups <- vsd_data %>% select(gene, 2:13)

# Rename the columns to make sure they are uniquely identifiable
colnames(data_all_groups) <- c("gene", paste0("Control_", 1:3), paste0("MAG_", 1:3), paste0("OA_", 1:3), paste0("PA_", 1:3))

# Separate out Group 5 (Control columns)
group5 <- data_all_groups %>% select(starts_with("Control"))

# Calculate average expression for Group 5 (Control)
avg_group5 <- group5 %>% rowMeans(na.rm = TRUE)

# Calculate differential expression for MAG, OA, PA relative to Group 5
data_diff <- data_all_groups %>%
  mutate(across(starts_with("MAG"), ~ . - avg_group5),
         across(starts_with("OA"), ~ . - avg_group5),
         across(starts_with("PA"), ~ . - avg_group5))

# Add back the gene names column
data_diff <- data_diff %>% mutate(gene = data_all_groups$gene)

# Rank the genes based on average differential expression
avg_diff_expression <- data_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff <- data_diff %>% mutate(avg_diff = avg_diff_expression) %>% arrange(desc(avg_diff))

# Select the top 25 genes with the highest average differential expression
top_genes_diff <- data_diff %>% head(25)

# Generate heatmap for the top 25 genes in differential expression
top_genes_diff_matrix <- top_genes_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% as.matrix()
rownames(top_genes_diff_matrix) <- top_genes_diff$gene

# Scaling the data for better visualization
top_genes_diff_matrix_scaled <- t(scale(t(top_genes_diff_matrix)))

# Define custom labels for samples (MAG, OA, PA)
col_labels <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Plot the heatmap using ComplexHeatmap
Heatmap(
  top_genes_diff_matrix_scaled,
  name = "Differential Expression",        # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  column_labels = col_labels,               # Custom labels for columns
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 9, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Differential Expression", at = round(seq(-lim, lim, length.out = 5), 4)),  # Legend title with rounded values to the nearest ten-thousandth
  column_title = "Top 25 Genes Differential Expression vs Control (5mM Sample)",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 12)     # Font size for the title
)

# Use the same data_diff from the heatmap step

# Rank the genes based on average differential expression for consistency
avg_diff_expression <- data_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff <- data_diff %>% mutate(avg_diff = avg_diff_expression) %>% arrange(desc(avg_diff))

# Select the top 25 genes for heatmap and scatter plot consistency
top_genes_diff <- data_diff %>% head(25)

# Plot the average differential expression of top 25 genes
library(ggrepel)

ggplot(top_genes_diff, aes(x = rank(avg_diff), y = avg_diff, label = gene)) +
  geom_point() +
  geom_vline(xintercept = 25, color = "red", linetype = "dashed") +
  geom_text_repel(size = 3) +  # Use geom_text_repel for clearer labels
  labs(title = "Average Differential Expression of Top 25 Genes", x = "Gene Rank", y = "Average Differential Expression")

```
```{r}
# Load required libraries
library(ComplexHeatmap)
library(dplyr)
library(ggplot2)
library(ggrepel)

# Extract only the columns corresponding to gene names and all conditions (Columns 2 to 13 for Group 5, MAG, OA, PA)
data_all_groups <- vsd_data %>% select(gene, 2:13)

# Rename the columns to make sure they are uniquely identifiable
colnames(data_all_groups) <- c("gene", paste0("Control_", 1:3), paste0("MAG_", 1:3), paste0("OA_", 1:3), paste0("PA_", 1:3))

# Separate out Group 5 (Control columns)
group5 <- data_all_groups %>% select(starts_with("Control"))

# Calculate average expression for Group 5 (Control)
avg_group5 <- group5 %>% rowMeans(na.rm = TRUE)

# Calculate differential expression for MAG, OA, PA relative to Group 5
data_diff <- data_all_groups %>%
  mutate(across(starts_with("MAG"), ~ . - avg_group5),
         across(starts_with("OA"), ~ . - avg_group5),
         across(starts_with("PA"), ~ . - avg_group5))

# Add back the gene names column
data_diff <- data_diff %>% mutate(gene = data_all_groups$gene)

# Rank the genes based on average differential expression
avg_diff_expression <- data_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff <- data_diff %>% mutate(avg_diff = avg_diff_expression) %>% arrange(desc(avg_diff))

# Select the top 25 genes with the highest average differential expression
top_genes_diff <- data_diff %>% head(25)

# Generate heatmap for the top 25 genes in differential expression
top_genes_diff_matrix <- top_genes_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% as.matrix()
rownames(top_genes_diff_matrix) <- top_genes_diff$gene

# Scaling the data for better visualization
top_genes_diff_matrix_scaled <- t(scale(t(top_genes_diff_matrix)))

# Define custom labels for samples (MAG, OA, PA)
col_labels <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Save the heatmap to a file
pdf("Top_25_Genes_Differential_Expression_Heatmap.pdf")
Heatmap(
  top_genes_diff_matrix_scaled,
  name = "Differential Expression",        # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  column_labels = col_labels,               # Custom labels for columns
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 9, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Differential Expression", at = round(seq(-lim, lim, length.out = 5), 4)),  # Legend title with rounded values to the nearest ten-thousandth
  column_title = "Top 25 Genes Differential Expression vs Control (5mM Sample)",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 12)     # Font size for the title
)
dev.off()

# Rank the genes based on average differential expression for consistency
avg_diff_expression <- data_diff %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff <- data_diff %>% mutate(avg_diff = avg_diff_expression) %>% arrange(desc(avg_diff))

# Select the top 25 genes for heatmap and scatter plot consistency
top_genes_diff <- data_diff %>% head(25)

# Plot the average differential expression of top 25 genes and save it to a file
scatter_plot <- ggplot(top_genes_diff, aes(x = rank(avg_diff), y = avg_diff, label = gene)) +
  geom_point() +
  geom_vline(xintercept = 25, color = "red", linetype = "dashed") +
  geom_text_repel(size = 3) +  # Use geom_text_repel for clearer labels
  labs(title = "Average Differential Expression of Top 25 Genes", x = "Gene Rank", y = "Average Differential Expression")

# Save the scatter plot
ggsave("Average_Differential_Expression_Top_25_Genes.png", scatter_plot, width = 10, height = 8)


```

```{r}
# Extract only the columns corresponding to gene names and 5mM condition (Columns 17:25 for 5mM)
data_5mM <- vsd_data %>% select(gene, 17:25)

# Calculate the average expression for the 5mM condition
avg_5mM <- data_5mM %>% select(-gene) %>% rowMeans(na.rm = TRUE)

# Add the average expression to the original data
data_5mM <- data_5mM %>% mutate(avg_5mM = avg_5mM)

# Rank the genes by the average expression level
vsd_data_ranked_5mM <- data_5mM %>% arrange(desc(avg_5mM))

# Select the top 25 genes with the highest average expression
top_genes_5mM <- vsd_data_ranked_5mM %>% head(25)

# Generate heatmap for the top 25 genes in 5mM condition
top_genes_5mM_matrix <- top_genes_5mM %>% select(-gene, -avg_5mM) %>% as.matrix()
rownames(top_genes_5mM_matrix) <- top_genes_5mM$gene

# Scaling the data for better visualization
top_genes_5mM_matrix_scaled <- t(scale(t(top_genes_5mM_matrix)))

# Define custom labels for samples (T6 for columns 17, 18, 19; T7 for columns 20, 21, 22; T8 for columns 23, 24, 25)
col_labels <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Plot the heatmap using ComplexHeatmap
heatmap_5mM <- Heatmap(
  top_genes_5mM_matrix_scaled,
  name = "Expression Level",                # Title for the color legend
  col = colorRampPalette(c("blue", "white", "red"))(100),  # Colors for the heatmap
  cluster_rows = TRUE,                      # Cluster rows
  cluster_columns = TRUE,                   # Cluster columns
  show_row_names = TRUE,                    # Show gene names
  column_labels = col_labels,               # Custom labels for columns
  show_column_names = TRUE,                 # Show sample labels
  row_names_gp = gpar(fontsize = 10, fontfamily = "sans", lineheight = 0.8),  # Adjust the font size and spacing for the gene names
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),  # Adjust the font size and rotation for the sample labels
  heatmap_legend_param = list(title = "Expression Level", at = round(seq(-max(abs(top_genes_5mM_matrix_scaled)), max(abs(top_genes_5mM_matrix_scaled)), length.out = 5), 4)),  # Legend title with rounded values
  column_title = "Top 25 Genes in 5mM Condition",  # Title for the heatmap
  column_title_gp = gpar(fontsize = 14)     # Font size for the title
)

# Save the heatmap to a file
png(filename = "Top_25_Genes_5mM_Heatmap.png", width = 800, height = 600)
draw(heatmap_5mM)
dev.off()

```

```{r}
# Load required libraries
library(tidyverse)
library(ComplexHeatmap)
library(circlize)
library(ggrepel)

# Define file path (assumed same as 5 mM file)
file_path <- "/Users/gui/Desktop/Normalized_VSD_1.csv"

# Load the dataset
vsd_data <- read_csv(file_path)

# Extract only the columns corresponding to gene names and all conditions (Columns B-M for 500 µM)
data_all_groups_500uM <- vsd_data %>% select(gene, 2:13)

# Rename the columns for clarity
colnames(data_all_groups_500uM) <- c("gene", paste0("Control_", 1:3), paste0("MAG_", 1:3), paste0("OA_", 1:3), paste0("PA_", 1:3))

# Separate out Control (Group 1) for differential expression calculations
group1_control <- data_all_groups_500uM %>% select(starts_with("Control"))

# Calculate average expression for Control
avg_control_500uM <- group1_control %>% rowMeans(na.rm = TRUE)

# Calculate differential expression for MAG, OA, PA relative to Control
data_diff_500uM <- data_all_groups_500uM %>%
  mutate(across(starts_with("MAG"), ~ . - avg_control_500uM),
         across(starts_with("OA"), ~ . - avg_control_500uM),
         across(starts_with("PA"), ~ . - avg_control_500uM))

# Add back the gene names column
data_diff_500uM <- data_diff_500uM %>% mutate(gene = data_all_groups_500uM$gene)

# Rank genes based on average differential expression
avg_diff_expression_500uM <- data_diff_500uM %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff_500uM <- data_diff_500uM %>% mutate(avg_diff = avg_diff_expression_500uM) %>% arrange(desc(avg_diff))

# Select the top 25 genes with the highest average differential expression
top_genes_diff_500uM <- data_diff_500uM %>% head(25)

# Generate heatmap for the top 25 differentially expressed genes in 500 µM
top_genes_diff_500uM_matrix <- top_genes_diff_500uM %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% as.matrix()
rownames(top_genes_diff_500uM_matrix) <- top_genes_diff_500uM$gene

# Scaling the data for better visualization
top_genes_diff_500uM_matrix_scaled <- t(scale(t(top_genes_diff_500uM_matrix)))

# Define custom labels for samples (MAG, OA, PA)
col_labels_500uM <- c(rep("MAG", 3), rep("Oleic Acid", 3), rep("Palmitic Acid", 3))

# Plot the heatmap for 500 µM condition
Heatmap(
  top_genes_diff_500uM_matrix_scaled,
  name = "Differential Expression",
  col = colorRampPalette(c("blue", "white", "red"))(100),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  show_row_names = TRUE,
  column_labels = col_labels_500uM,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 9, fontfamily = "sans", lineheight = 0.8),
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),
  heatmap_legend_param = list(title = "Differential Expression"),
  column_title = "Top 25 Genes Differential Expression vs Control (500 µM Sample)",
  column_title_gp = gpar(fontsize = 12)
)

# Rank the genes based on average differential expression for consistency
avg_diff_expression_500uM <- data_diff_500uM %>% select(starts_with("MAG"), starts_with("OA"), starts_with("PA")) %>% rowMeans(na.rm = TRUE)
data_diff_500uM <- data_diff_500uM %>% mutate(avg_diff = avg_diff_expression_500uM) %>% arrange(desc(avg_diff))

# Select the top 25 genes for heatmap and scatter plot consistency
top_genes_diff_500uM <- data_diff_500uM %>% head(25)

# Scatter plot of the average differential expression of top 25 genes
ggplot(top_genes_diff_500uM, aes(x = rank(avg_diff), y = avg_diff, label = gene)) +
  geom_point() +
  geom_vline(xintercept = 25, color = "red", linetype = "dashed") +
  geom_text_repel(size = 3) +
  labs(title = "Average Differential Expression of Top 25 Genes (500 µM Sample)", x = "Gene Rank", y = "Average Differential Expression")

```
```{r}
# 1) Reorder the columns so OA comes first, then MAG, then PA
top_genes_diff_matrix <- top_genes_diff %>%
  select(starts_with("OA"), starts_with("MAG"), starts_with("PA")) %>%
  as.matrix()

# 2) Keep your row names as the gene names
rownames(top_genes_diff_matrix) <- top_genes_diff$gene

# 3) Scale the matrix if you did that before
top_genes_diff_matrix_scaled <- t(scale(t(top_genes_diff_matrix)))

# 4) Update your column labels to match the new order
col_labels <- c(rep("Oleic Acid", 3), rep("MAG", 3), rep("Palmitic Acid", 3))

# 5) Plot the heatmap with columns in this fixed order
Heatmap(
  top_genes_diff_matrix_scaled,
  name = "Differential Expression",
  col = colorRampPalette(c("blue", "white", "red"))(100),
  cluster_rows = TRUE,       # cluster genes (rows) if you like
  cluster_columns = FALSE,   # keep columns in the exact OA, MAG, PA order
  show_row_names = TRUE,
  column_labels = col_labels,
  show_column_names = TRUE,
  row_names_gp = gpar(fontsize = 9, fontfamily = "sans", lineheight = 0.8),
  column_names_gp = gpar(fontsize = 10, rot = 90, fontfamily = "sans"),
  column_title = "Top 25 Genes Differential Expression vs Control (5mM Sample)",
  column_title_gp = gpar(fontsize = 12)
)

```








`